#!/bin/bash
set -e

# Script para configurar backend S3 pela primeira vez
# Execute apenas uma vez antes do primeiro deploy

echo "üöÄ Configurando backend S3 para Terraform state..."

# Verifica se AWS CLI est√° configurado
if ! aws sts get-caller-identity &> /dev/null; then
  echo "‚ùå AWS CLI n√£o est√° configurado. Execute: aws configure"
  exit 1
fi

echo "‚úÖ AWS credentials v√°lidas"

# Navega para diret√≥rio terraform
cd "$(dirname "$0")/../../terraform"

# Cria bucket S3 diretamente via AWS CLI
BUCKET_NAME="${PROJECT_NAME:-token-service}-terraform-state"
REGION="us-east-1"

echo "‚òÅÔ∏è  Criando bucket S3 para Terraform state..."

# Verifica se bucket j√° existe
if aws s3 ls "s3://$BUCKET_NAME" 2>/dev/null; then
  echo "‚úÖ Bucket j√° existe: $BUCKET_NAME"
else
  # Cria bucket
  aws s3api create-bucket \
    --bucket "$BUCKET_NAME" \
    --region "$REGION" \
    2>/dev/null || echo "‚ö†Ô∏è  Erro ao criar bucket (pode j√° existir)"
  
  # Habilita versionamento
  aws s3api put-bucket-versioning \
    --bucket "$BUCKET_NAME" \
    --versioning-configuration Status=Enabled
  
  # Habilita criptografia
  aws s3api put-bucket-encryption \
    --bucket "$BUCKET_NAME" \
    --server-side-encryption-configuration '{
      "Rules": [{
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        }
      }]
    }'
  
  # Bloqueia acesso p√∫blico
  aws s3api put-public-access-block \
    --bucket "$BUCKET_NAME" \
    --public-access-block-configuration \
      BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
  
  echo "‚úÖ Bucket criado e configurado: $BUCKET_NAME"
fi

# Inicializa terraform localmente (sem backend ainda)
echo "üì¶ Inicializando Terraform..."
terraform init

# Reconfigura terraform para usar backend S3
echo "üîÑ Migrando state local para S3..."
terraform init -backend-config=backend.hcl -migrate-state -force-copy

echo ""
echo "‚úÖ Backend S3 configurado com sucesso!"
echo ""
echo "üìù Pr√≥ximos passos:"
echo "  1. Commit e push das mudan√ßas"
echo "  2. Configure secrets no GitHub:"
echo "     - AWS_ACCESS_KEY_ID"
echo "     - AWS_SECRET_ACCESS_KEY"
echo "  3. GitHub Actions far√° o deploy automaticamente"
echo ""

